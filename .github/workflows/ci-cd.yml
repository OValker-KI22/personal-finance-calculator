name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  # 1. –¢–ï–°–¢–´ –Ω–∞ GitHub —Å–µ—Ä–≤–µ—Ä–∞—Ö
  tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install dependencies
      run: pip install -r requirements.txt
    - name: Run tests
      run: python -m pytest test_calculator.py -v

  # 2. –î–ï–ü–õ–û–ô –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä (self-hosted runner)
  deploy-to-production:
    runs-on: self-hosted  # –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à runner
    needs: tests  # –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
    if: github.event_name == 'push'  # –¢–æ–ª—å–∫–æ –ø—Ä–∏ push
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to local Windows
      shell: pwsh
      run: |
        Write-Host "=========================================" -ForegroundColor Cyan
        Write-Host "üöÄ DEPLOYING TO LOCAL PRODUCTION SERVER" -ForegroundColor Green
        Write-Host "=========================================" -ForegroundColor Cyan
        
        # 1. –°–æ–∑–¥–∞—ë–º –ø—Ä–æ–¥—É–∫—Ç–æ–≤—É—é –ø–∞–ø–∫—É
        $prodDir = "C:\personal-finance-prod"
        Write-Host "Production directory: $prodDir"
        
        if (!(Test-Path $prodDir)) {
          New-Item -ItemType Directory -Path $prodDir -Force
          Write-Host "‚úÖ Created production directory" -ForegroundColor Green
        }
        
        # 2. –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
        Write-Host "`nüìÅ Copying files..." -ForegroundColor Yellow
        $files = @("main.py", "requirements.txt", "test_calculator.py")
        foreach ($file in $files) {
          if (Test-Path $file) {
            Copy-Item $file -Destination $prodDir -Force
            Write-Host "  ‚úÖ $file" -ForegroundColor Green
          } else {
            Write-Host "  ‚ùå $file (not found)" -ForegroundColor Red
          }
        }
        
        # 3. –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–µ–ø–ª–æ–µ
        $deployInfo = @"
================================
PERSONAL FINANCE CALCULATOR
================================
DEPLOYMENT INFORMATION:
- Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- Repository: ${{ github.repository }}
- Commit: ${{ github.sha }}
- Branch: ${{ github.ref }}
- Deployed to: $prodDir

INSTRUCTIONS:
1. Open PowerShell
2. Run: cd $prodDir
3. Run: python main.py
4. For tests: python -m pytest test_calculator.py -v
================================
"@
        
        $deployInfo | Out-File "$prodDir\DEPLOYMENT_INFO.txt" -Encoding UTF8
        Write-Host "`nüìù Created deployment info file" -ForegroundColor Yellow
        
        # 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        Write-Host "`n=========================================" -ForegroundColor Cyan
        Write-Host "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY!" -ForegroundColor Green
        Write-Host "=========================================" -ForegroundColor Cyan
        Write-Host "`nProduction files:" -ForegroundColor Yellow
        Get-ChildItem $prodDir | ForEach-Object { 
          Write-Host "  - $($_.Name) ($($_.Length) bytes)" 
        }
        
        Write-Host "`nTo run the application:" -ForegroundColor Magenta
        Write-Host "  cd $prodDir"
        Write-Host "  python main.py"