name: CI/CD Pipeline

on:
  push:
    branches: [ main ] 

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install dependencies
      run: pip install -r requirements.txt
    - name: Run tests
      run: python -m pytest test_calculator.py -v

  deploy-to-production:
    runs-on: self-hosted
    needs: tests
    if: github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Simple Deploy to Windows
      shell: powershell  
      run: |
        # Создаем папку
        $target = "C:\finance-app-production"
        Write-Host "Target directory: $target"
        
        if (!(Test-Path $target)) {
          New-Item -ItemType Directory -Path $target -Force
          Write-Host "Created directory: $target"
        }
        
        # Копируем файлы
        Write-Host "Copying files..."
        Copy-Item "main.py" -Destination $target -Force
        Copy-Item "requirements.txt" -Destination $target -Force
        Copy-Item "test_calculator.py" -Destination $target -Force
        
        # Пишем лог
        $time = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        "Deployed: $time" | Out-File "$target\deploy.log" -Encoding UTF8
        
        # Выводим результат
        Write-Host "=== DEPLOYMENT SUCCESSFUL! ==="
        Write-Host "Location: $target"
        Write-Host "Files deployed:"
        Get-ChildItem $target | ForEach-Object { 
          Write-Host "  - $($_.Name) ($($_.Length) bytes)" 
        }